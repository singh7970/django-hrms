{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Time Dashboard</title>

    <link href="{% static 'css/font-face.css' %}" rel="stylesheet">
    <link href="{% static 'vendor/font-awesome-4.7/css/font-awesome.min.css' %}" rel="stylesheet">
    <link href="{% static 'vendor/font-awesome-5/css/fontawesome-all.min.css' %}" rel="stylesheet">
    <link href="{% static 'vendor/mdi-font/css/material-design-iconic-font.min.css' %}" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="{% static 'vendor/bootstrap-4.1/bootstrap.min.css' %}" rel="stylesheet">
    <link href="{% static 'vendor/animsition/animsition.min.css' %}" rel="stylesheet">
    <link href="{% static 'vendor/select2/select2.min.css' %}" rel="stylesheet">
    <link href="{% static 'vendor/perfect-scrollbar/perfect-scrollbar.css' %}" rel="stylesheet">
    <link href="{% static 'css/time_dashboard.css' %}" rel="stylesheet">

</head>
<body class="animsition">
<div class="page-wrapper">
    {% include 'sidebar.html' %}
    <div class="page-container">
        {% include 'navbar.html' %}

        <div class="main-content">
            <div class="section__content section__content--p30">
                <div class="scroll-container container-fluid">

                    <div class="d-flex justify-content-start gap-4 mb-4">
                        <div class="dropdown mr-3">
                            <a class="btn btn-light dropdown-toggle" href="#" data-toggle="dropdown">Time Dashboard</a>
                            <div class="dropdown-menu">
                                <a class="dropdown-item" href="{% url 'time_dashboard' %}">Dashboard</a>
                            </div>
                        </div>
                        <div class="dropdown mr-3">
                            <a class="btn btn-light dropdown-toggle" href="#" data-toggle="dropdown">Attendance</a>
                            <div class="dropdown-menu">
                                <a class="dropdown-item" href="{% url 'punchin_out_view' %}">Punch In/Out</a>
                                <a class="dropdown-item" href="{% url 'attendance_records' %}">My Records</a>
                            </div>
                        </div>
                        <div class="dropdown mr-3">
                            <a class="btn btn-light dropdown-toggle" href="#" data-toggle="dropdown">Reports</a>
                            <div class="dropdown-menu">
                                <a class="dropdown-item" href="#">Performance</a>
                            </div>
                        </div>
                    </div>

                    {% if disable_punch %}
                        <div class="alert alert-danger mt-2">You have been punched in for over 40 hours. Please contact HR.</div>
                    {% endif %}

                    <div class="attendance-section">
                        <h1 class="section-title">Attendance Dashboard</h1>

                        <div class="content-area">
                            <div class="calendar-section">
                                <div class="calendar-header">
                                    <span>Attendance Dashboard</span>
                                </div>

                                <div class="calendar-header">
                                    <div class="date-input-container">
                                        <input type="text" class="date-input" placeholder="MM/YYYY" value="{{ current_month|stringformat:'02d' }}/{{ current_year }}" id="monthInput" readonly>
                                        <i class="fas fa-calendar-alt calendar-icon" id="calendarIcon"></i>
                                    </div>
                                    <button class="go-btn" onclick="updateMonth()">GO</button>
                                    
                                    <!-- Calendar Popup -->
                                    <div class="calendar-popup" id="calendarPopup">
                                        <div class="calendar-header-popup">
                                            <h4>Select Month & Year</h4>
                                        </div>
                                        
                                        <!-- Year Selection -->
                                        <div class="year-selection">
                                            <label>Year:</label>
                                            <div class="year-nav">
                                                <button type="button" class="nav-btn" id="prevYearBtn">&lt;&lt;</button>
                                                <span class="current-year" id="currentYear"></span>
                                                <button type="button" class="nav-btn" id="nextYearBtn">&gt;&gt;</button>
                                            </div>
                                        </div>
                                        
                                        <!-- Month Selection -->
                                        <div class="month-selection">
                                            <label>Month:</label>
                                            <div class="months-grid" id="monthsGrid">
                                                <!-- Month buttons will be generated here -->
                                            </div>
                                        </div>
                                        
                                        <div class="calendar-footer">
                                            <button type="button" class="btn-today" id="btnToday">Current Month</button>
                                            <button type="button" class="btn-close" id="btnClose">Close</button>
                                        </div>
                                    </div>
                                </div>

                                <div class="calendar-grid" id="calendarGrid">
                                    <div class="calendar-day-header">Sun</div>
                                    <div class="calendar-day-header">Mon</div>
                                    <div class="calendar-day-header">Tue</div>
                                    <div class="calendar-day-header">Wed</div>
                                    <div class="calendar-day-header">Thu</div>
                                    <div class="calendar-day-header">Fri</div>
                                    <div class="calendar-day-header">Sat</div>
{% for cell in calendar_cells %}
    {% if cell.day %}
        <div class="calendar-day {{ cell.status }} {% if cell.day == today.day and current_month == today.month and current_year == today.year %}today{% endif %}"
             data-date="{{ cell.day }}" 
             data-status="{{ cell.status }}"
             {% if cell.duration %}data-duration="{{ cell.duration }}"{% endif %}
             {% if cell.punch_in %}data-punch-in="{{ cell.punch_in }}"{% endif %}
             {% if cell.punch_out %}data-punch-out="{{ cell.punch_out }}"{% endif %}
             data-has-record="{{ cell.has_record|yesno:'true,false' }}"
             title="{% if cell.status == 'present' %}Full Day{% elif cell.status == 'halfday' %}Half Day{% elif cell.status == 'sick' %}Sick Leave{% elif cell.status == 'absent' %}Absent{% elif cell.status == 'holiday' %}Holiday{% elif cell.status == 'punchin' %}Punched In{% else %}No Record{% endif %}{% if cell.duration %} - Duration: {{ cell.duration }}{% endif %}{% if cell.punch_in and cell.punch_out %} ({{ cell.punch_in }} - {{ cell.punch_out }}){% elif cell.punch_in %} (In: {{ cell.punch_in }}){% endif %}">
            {{ cell.day }}
        </div>
    {% else %}
        <div class="calendar-day empty"></div>
    {% endif %}
{% endfor %}


                                </div>


                            </div>

                            <div class="sidebar-right">
                                <div class="info-panel">
                                    <h3>Monthly Summary</h3>
                                    <div class="stats-row">
                                        <div class="stat-number" id="presentDays">{{ present_days }}<div class="stat-label">full day</div></div>
<div class="stat-number" id="halfDays">{{ half_days }}<div class="stat-label">half day</div></div>
<div class="stat-number" id="absentDays">{{ absent_days }}<div class="stat-label">absent</div></div>
                                    </div>
                                    <div class="stats-row">
<div class="stat-number" id="sickDays">{{ sick_days }}<div class="stat-label">sick</div></div>
<div class="stat-number" id="holidayDays">{{ holiday_days }}<div class="stat-label">holiday</div></div>
                                    </div>
                                </div>
<div class="info-panel">
    <h3>Holidays This Month</h3>
    {% if holidays %}
        <ul class="list-group">
            {% for holiday in holidays %}
                <li class="list-group-item d-flex justify-content-between align-items-center holiday-item">
                    <span class="holiday-name" title="{{ holiday.occasion }}">{{ holiday.occasion }}</span>
                    <span class="badge badge-primary badge-pill">{{ holiday.date|date:"d M, Y" }}</span>
                </li>
            {% endfor %}
        </ul>
    {% else %}
        <p>No holidays this month.</p>
    {% endif %}
</div>

                                <div class="info-panel">
                                    <div class="selected-date-info" id="selectedDateInfo">
                                        <h4>ðŸ“… Status Legend</h4>
                                        <p>Calendar status symbols and meanings</p>
                                        <div class="status-symbols">
                                            <div class="symbol-item"><span class="status-symbol">ðŸŸ¢</span> Full Day (8+ hours)</div>
                                            <div class="symbol-item"><span class="status-symbol">ðŸ”µ</span> Half Day (&lt;8 hours)</div>
                                            <div class="symbol-item"><span class="status-symbol">ðŸŸ </span> Sick Leave</div>
                                            <div class="symbol-item"><span class="status-symbol">ðŸ”´</span> Absent</div>
                                            <div class="symbol-item"><span class="status-symbol">ðŸŸ£</span> Holiday</div>
                                            <div class="symbol-item"><span class="status-symbol">ðŸ”¶</span> Punched In</div>
                                        </div>
                                    </div>

                                    <div class="quick-actions" id="quickActions" style="display: none;">
                                        <button class="action-btn" onclick="updateStatus('present')">Mark Present</button>
                                        <button class="action-btn" onclick="updateStatus('absent')">Mark Absent</button>
                                        <button class="action-btn" onclick="updateStatus('sick')">Mark Sick</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>
</div>

<script>
     // Simple calendar functionality
function updateMonth() {
    const input = document.getElementById('monthInput').value;
    const [monthStr, yearStr] = input.split('/');
    const month = parseInt(monthStr);
    const year = parseInt(yearStr);
    if (!isNaN(month) && !isNaN(year)) {
        window.location.href = `?month=${month}&year=${year}`;
    }
}

// Calendar variables
let currentCalendarDate = new Date();
let selectedDate = null;
let isCalendarVisible = false;

// Initialize calendar when page loads
document.addEventListener('DOMContentLoaded', function() {
    console.log('Calendar initializing...');
    
    const calendarIcon = document.getElementById('calendarIcon');
    const monthInput = document.getElementById('monthInput');
    const calendarPopup = document.getElementById('calendarPopup');
    
    console.log('Elements found:', {
        icon: !!calendarIcon,
        input: !!monthInput,
        popup: !!calendarPopup
    });
    
    // Get current month from input
    if (monthInput && monthInput.value) {
        const [month, year] = monthInput.value.split('/');
        currentCalendarDate = new Date(parseInt(year), parseInt(month) - 1, 1);
    }
    
    // Show calendar when clicking input or icon
    if (calendarIcon) {
        calendarIcon.addEventListener('click', function(e) {
            console.log('Calendar icon clicked');
            e.stopPropagation();
            toggleCalendar();
        });
    }
    
    if (monthInput) {
        monthInput.addEventListener('click', function(e) {
            console.log('Input field clicked');
            e.stopPropagation();
            toggleCalendar();
        });
    }
    
    // Year navigation buttons
    const prevYearBtn = document.getElementById('prevYearBtn');
    const nextYearBtn = document.getElementById('nextYearBtn');
    if (prevYearBtn) {
        prevYearBtn.addEventListener('click', function() {
            currentCalendarDate.setFullYear(currentCalendarDate.getFullYear() - 1);
            renderCalendar();
        });
    }
    if (nextYearBtn) {
        nextYearBtn.addEventListener('click', function() {
            currentCalendarDate.setFullYear(currentCalendarDate.getFullYear() + 1);
            renderCalendar();
        });
    }
    
    // Footer buttons
    const btnToday = document.getElementById('btnToday');
    const btnClose = document.getElementById('btnClose');
    if (btnToday) {
        btnToday.addEventListener('click', function() {
            const today = new Date();
            currentCalendarDate = new Date(today.getFullYear(), today.getMonth(), 1);
            selectedDate = today;
            renderCalendar();
            updateInput();
        });
    }
    if (btnClose) {
        btnClose.addEventListener('click', function() {
            hideCalendar();
        });
    }
    
    // Close calendar when clicking outside
    document.addEventListener('click', function(e) {
        if (calendarPopup && !calendarPopup.contains(e.target) && 
            !calendarIcon.contains(e.target) && !monthInput.contains(e.target)) {
            hideCalendar();
        }
    });
    
    console.log('Calendar initialization complete');
});

function toggleCalendar() {
    console.log('Toggle calendar called, current visibility:', isCalendarVisible);
    if (isCalendarVisible) {
        hideCalendar();
    } else {
        showCalendar();
    }
}

function showCalendar() {
    console.log('Showing calendar');
    const calendarPopup = document.getElementById('calendarPopup');
    if (calendarPopup) {
        calendarPopup.style.display = 'block';
        isCalendarVisible = true;
        renderCalendar();
        console.log('Calendar should now be visible');
    } else {
        console.error('Calendar popup element not found');
    }
}

function hideCalendar() {
    console.log('Hiding calendar');
    const calendarPopup = document.getElementById('calendarPopup');
    if (calendarPopup) {
        calendarPopup.style.display = 'none';
        isCalendarVisible = false;
    }
}

function renderCalendar() {
    console.log('Rendering month/year picker for:', currentCalendarDate);
    const monthNames = [
        'January', 'February', 'March', 'April', 'May', 'June',
        'July', 'August', 'September', 'October', 'November', 'December'
    ];
    const monthShortNames = [
        'Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun',
        'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'
    ];
    
    // Update year display
    const currentYear = document.getElementById('currentYear');
    if (currentYear) {
        currentYear.textContent = currentCalendarDate.getFullYear();
    }
    
    // Generate month buttons
    const monthsGrid = document.getElementById('monthsGrid');
    if (monthsGrid) {
        monthsGrid.innerHTML = '';
        
        const today = new Date();
        const currentMonth = currentCalendarDate.getMonth();
        const currentYear = currentCalendarDate.getFullYear();
        
        for (let month = 0; month < 12; month++) {
            const monthBtn = document.createElement('div');
            monthBtn.className = 'month-btn';
            monthBtn.textContent = monthShortNames[month];
            monthBtn.dataset.month = month;
            
            // Highlight current month if it's the current year
            if (today.getFullYear() === currentYear && today.getMonth() === month) {
                monthBtn.classList.add('current');
            }
            
            // Highlight selected month
            if (selectedDate && 
                selectedDate.getFullYear() === currentYear && 
                selectedDate.getMonth() === month) {
                monthBtn.classList.add('selected');
            }
            
            monthBtn.addEventListener('click', function() {
                selectMonth(month);
            });
            
            monthsGrid.appendChild(monthBtn);
        }
    }
}

function selectMonth(month) {
    console.log('Month selected:', month);
    selectedDate = new Date(currentCalendarDate.getFullYear(), month, 1);
    renderCalendar();
    updateInput();
    hideCalendar();
}

function updateInput() {
    const monthInput = document.getElementById('monthInput');
    if (monthInput && selectedDate) {
        const month = String(selectedDate.getMonth() + 1).padStart(2, '0');
        const year = selectedDate.getFullYear();
        monthInput.value = `${month}/${year}`;
        console.log('Input updated to:', monthInput.value);
    }
}    
</script>

<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.bundle.min.js"></script>
</body>
</html>
